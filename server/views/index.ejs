<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>NodeStock - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-3xl font-bold text-gray-800">üì¶ Inventario NodeStock</h1>
            
            <div class="flex items-center gap-4 w-full md:w-auto">
                <input type="text" id="busqueda" placeholder="Buscar nombre o SKU..." 
                    class="border border-gray-300 p-2 rounded-lg w-full md:w-64 focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm">
                
                <button onclick="document.getElementById('modalProducto').classList.remove('hidden')" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold transition-all shadow-md flex items-center gap-2 whitespace-nowrap">
                    <span>+</span> Nuevo Producto
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr class="text-gray-600 text-sm uppercase tracking-wider">
                        <th class="p-4 font-semibold">Producto</th>
                        <th class="p-4 font-semibold text-center">SKU</th>
                        <th class="p-4 text-center font-semibold">Stock</th>
                        <th class="p-4 text-right font-semibold">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tabla-body" class="divide-y divide-gray-100">
                    </tbody>
            </table>
        </div>
    </div>

    <%- include('partials/modal-producto') %>

    <script>
        let productos = [];

        // Cargar productos desde la API
        async function load() {
            try {
                const res = await fetch('/api/products');
                productos = await res.json();
                render(productos);
            } catch (error) {
                console.error("Error al cargar productos:", error);
            }
        }

        // Renderizar la tabla con estilos y botones
        function render(data) {
            const body = document.getElementById('tabla-body');
            
            if (data.length === 0) {
                body.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-500 italic">No se encontraron productos en el inventario.</td></tr>`;
                return;
            }

            body.innerHTML = data.map(p => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-4 font-bold text-gray-800">${p.name}</td>
                    <td class="p-4 text-gray-500 text-center font-mono text-sm">${p.sku}</td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-bold border ${p.stock < 5 ? 'bg-red-100 text-red-700 border-red-200' : 'bg-green-100 text-green-700 border-green-200'}">
                            ${p.stock}
                        </span>
                    </td>
                    <td class="p-4 text-right flex justify-end gap-4">
                        <a href="/producto/${p.id}" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center gap-1">
                            üìä Historial
                        </a>
                        <button onclick="eliminarProducto('${p.id}')" class="text-red-500 hover:text-red-700 font-medium text-sm flex items-center gap-1">
                            üóëÔ∏è Eliminar
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // L√≥gica del buscador
        document.getElementById('busqueda').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const filtrados = productos.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.sku.toLowerCase().includes(term)
            );
            render(filtrados);
        };

        // Funci√≥n para eliminar producto con confirmaci√≥n
        async function eliminarProducto(id) {
            if (confirm('¬øEst√°s seguro de eliminar este producto? Esta acci√≥n no se puede deshacer y borrar√° su historial.')) {
                try {
                    const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        load(); // Recarga la lista desde el servidor
                    } else {
                        alert('Error al intentar eliminar el producto.');
                    }
                } catch (error) {
                    console.error("Error:", error);
                }
            }
        }

        // Carga inicial
        load();
    </script>
</body>
</html>